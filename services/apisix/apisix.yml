#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

upstreams:
  - id: "drupal"
    nodes:
        "drupal:80": 1
    type: "roundrobin"
    scheme: "http"
    pass_host: node
  - id: "prestashop"
    nodes:
        "prestashop:443": 1
    type: "roundrobin"
    scheme: "https"
    pass_host: node
    
routes:
  -
    name: "drupal_api"
    uri: "/cms/*"
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
    upstream_id: "drupal"
    plugins:
      proxy-rewrite:
        uri: "/jsonapi/$1"
      response-rewrite:                  # Set mimetypes
        headers:
          Content-Type: "$upstream_http_content_type" 
      zipkin:
        endpoint: "http://zipkin:9411/api/v2/spans"
        sample_ratio: 1
        service_name: drupal_api                

  -
    name: "prestashop_api"
    uri: "/ecommerce"
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
    upstream_id: "prestashop"
    plugins:
      proxy-rewrite:
        uri: "/api"
      zipkin:
        endpoint: "http://zipkin:9411/api/v2/spans"
        sample_ratio: 1
        service_name: prestashop_api
      response-rewrite:
        headers:
          Content-Type: "$upstream_http_content_type"  


#END